---
title: "Level of Consciousness vs Physical HRQOL"
author: "Jennifer Thompson, MPH<br>Supervisor: Rameela Chandrasekhar, PhD"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output:
  tufte::tufte_html:
    toc: TRUE
    toc_depth: 1
---

<style>
.plotlymargin { margin-right: 0; }
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

library(knitr)
library(tufte)
library(tidyverse)
library(stringr)
library(glue)
library(kableExtra)
library(tableone)
library(rms)
library(naniar)
library(plotly)
library(MESS)
library(JTHelpers)

load("data/brainmind_deid.Rdata")

## Source helper functions
source("R/helpers.R")
sum_na <- partial(sum, na.rm = TRUE)

## How many imputations for multiple imputation?
n_imp <- 15

## -- Remove variable labels (don't play nicely with pipes) --------------------
brainmind.oneobs <- clear.labels(brainmind.oneobs)
brainmind.daily <- clear.labels(brainmind.daily)
brainmind.fu <- clear.labels(brainmind.fu)
brainmind.exc <- clear.labels(brainmind.exc)

```

```{r consort_df}
## -- How many days with RASS available for each patient? ----------------------
## Can't be included in any analysis if not at least two
n_rass_days <- brainmind.assess %>%
  filter(!is.na(rass.daily)) %>%
  distinct(id, study.day) %>%
  count(id) %>%
  mutate(elig_auc_total = n >= 2)

## -- Determine status at each follow-up point ---------------------------------
fu_wide <- brainmind.fu %>%
  dplyr::select(id, fu.period, status) %>%
  filter(fu.period %in% paste(c(3, 12), "Month")) %>%
  mutate(
    ## Make ID character for compatibility with exclusion log
    id = as.character(id),
    fu.period = str_remove(fu.period, " Month"),
    status = forcats::fct_collapse(
      status,
      "Alive and in study" = c(
        "Living", "Living-Active in the study",
        "Lost to Follow-Up - Case Closed", "Visit Not Completed",
        "Still Trying to Contact"
      ),
      "Died before follow-up" = "Deceased",
      "Withdrew before follow-up" = "Living-Withdrew from the study"
    ),
    status = as.character(status)
  ) %>%
  spread(key = fu.period, value = status, sep = ".") %>%
  set_names(gsub("^fu\\.period", "status", names(.)))

screened_df <- bind_rows(
  brainmind.exc %>%
    mutate(
      id = paste(site, ex.id, sep = "-"),
      exc_status = case_when(
        stringr::str_sub(exc.rsn, 1, 2) == "9." ~ "Refused consent",
        TRUE                                    ~ "Excluded"
      )
    ) %>%
    dplyr::select(id, exc_status),
  brainmind.oneobs %>%
    dplyr::select(id, studywd.amt, died.inhosp) %>%
    left_join(n_rass_days, by = "id") %>%
    mutate(
      id = as.character(id),
      exc_status = "Enrolled",
      wd_data = studywd.amt %in% c(
        "2. W/D from Participation and All Data Collected",
        "4. N/A Study Staff Withdrew Patient"
      ) | id == 14015 ## withdrew data, but staff did not record appropriately
    )
) %>%
  mutate(
    dc_status = factor(
      case_when(
        wd_data                                                 ~ as.numeric(NA),
        !is.na(died.inhosp) & died.inhosp == "Died in hospital" ~ 1,
        !is.na(studywd.amt)                                     ~ 2,
        !(exc_status == "Enrolled")                             ~ as.numeric(NA),
        !elig_auc_total                                         ~ 3,
        TRUE                                                    ~ 4
      ),
      levels = 1:4,
      labels = c(
        "Died during hospitalization",
        "Withdrew during hospitalization",
        "Survived with <2 days with RASS",
        "ICU survivor, eligible for inclusion"
      )
    )
  ) %>%
  left_join(fu_wide, by = "id") %>%
  ## Fill in missing statuses
  mutate(
    ## Assume missing at 3m indicates no follow-up but patient still alive and
    ##  in study (no death or withdrawal recorded)
    status.3 = case_when(
      exc_status != "Enrolled" |
        wd_data |
        dc_status != "ICU survivor, eligible for inclusion" ~
        as.character(NA),
      !is.na(status.3) ~ status.3,
      TRUE ~ "Alive and in study"
    ),
    ## 12m status is NA if patient died or withdrew before 3m; otherwise, if
    ##  missing, assume patient was alive and in study (no death/withdrawal rec.)
    status.12 = case_when(
      exc_status != "Enrolled" |
        wd_data |
        dc_status != "ICU survivor, eligible for inclusion" |
        status.3 %in% paste(c("Died", "Withdrew"), "before follow-up") ~
          as.character(NA),
      !is.na(status.12) ~ status.12,
      TRUE ~ "Alive and in study"
    )
  )

## -- IDs of patients in discharge, 3m, 12m cohorts ----------------------------
ids_discharge <- screened_df %>%
  filter(dc_status == "ICU survivor, eligible for inclusion") %>% pull(id)
ids_3m <- screened_df %>% filter(status.3 == "Alive and in study") %>% pull(id)
ids_12m <- screened_df %>% filter(status.12 == "Alive and in study") %>% pull(id)

## -- Combine info for CONSORT table -------------------------------------------
consort_screen <- tribble(
  ~ current, ~ npts, ~ denom,
  "Screened", nrow(screened_df), NA,
  "Excluded", sum_na(screened_df$exc_status == "Excluded"), nrow(screened_df),
  "Approached", sum_na(screened_df$exc_status %in% c("Enrolled", "Refused consent")), nrow(screened_df),
  "Refused consent", sum_na(screened_df$exc_status == "Refused consent"),
    sum_na(screened_df$exc_status %in% c("Enrolled", "Refused consent")),
  "Enrolled", sum_na(screened_df$exc_status == "Enrolled"),
    sum_na(screened_df$exc_status %in% c("Enrolled", "Refused consent")),
  "Withdrew all data", sum_na(screened_df$wd_data),
    sum_na(screened_df$exc_status == "Enrolled"),
  "Eligible for in-hospital assessments", sum_na(!screened_df$wd_data),
    sum_na(screened_df$exc_status == "Enrolled")
)

n_elig_hosp <- sum_na(!screened_df$wd_data)

consort_inhosp <- tribble(
  ~ current, ~ npts,
  "Died in hospital",
    sum_na(screened_df$dc_status == "Died during hospitalization"),
  "Withdrew in hospital",
    sum_na(screened_df$dc_status == "Withdrew during hospitalization"),
  "Discharged, but <2 days with RASS",
    sum_na(screened_df$dc_status == "Survived with <2 days with RASS"),
  "Discharged, remained in study",
    sum_na(screened_df$dc_status == "ICU survivor, eligible for inclusion")
) %>%
  mutate(denom = n_elig_hosp)

n_elig_dc <-
  sum_na(screened_df$dc_status == "ICU survivor, eligible for inclusion")

## -- 3m followup section ------------------------------------------------------
consort_3m <- tribble(
  ~ current,                            ~ npts,
  "Alive and in study at discharge",
    sum_na(screened_df$dc_status == "ICU survivor, eligible for inclusion"),
  "Died before 3m follow-up",
    sum_na(screened_df$status.3 == "Died before follow-up"),
  "Withdrew before 3m follow-up",
    sum_na(screened_df$status.3 == "Withdrew before follow-up"),
  "Included in 3m follow-up cohort",
    sum_na(screened_df$status.3 == "Alive and in study")
) %>%
  mutate(denom = n_elig_dc)

n_elig_3m <- sum_na(screened_df$status.3 == "Alive and in study")

## -- 12m followup section -----------------------------------------------------
consort_12m <- tribble(
  ~ current,                            ~ npts,
  "Alive and in study at 3m follow-up",
    sum_na(screened_df$status.3 == "Alive and in study"),
  "Died before 12m follow-up",
    sum_na(screened_df$status.12 == "Died before follow-up"),
  "Withdrew before 12m follow-up",
    sum_na(screened_df$status.12 == "Withdrew before follow-up"),
  "Included in 12m follow-up cohort",
    sum_na(screened_df$status.12 == "Alive and in study")
) %>%
  mutate(denom = n_elig_3m)

consort_info <- bind_rows(
  consort_screen, consort_inhosp, consort_3m, consort_12m
) %>%
  mutate(
    denom = ifelse(
      current %in%
        paste("Alive and in study at", c("discharge", "3m follow-up")),
      NA,
      denom
    ),
    prop = round(npts / denom, 2),
    npct = glue::glue("{npts} ({scales::percent(prop)})"),
    npct = stringr::str_remove(npct, " \\(NA\\%\\)")
)

```

```{r data_prep}
## -- Calculate AUC for lowest daily RASSes (exposure) -------------------------
## "AUC" = amount of "low LOC" each patient experienced in the hospital
## Very, very few research RASSes were >0; combine these with 0, since our
##  primary question of interest is really about sedation

## Find lowest research staff RASS on each study day; this will be summarized
##  as our primary exposure
low_rasses_res <- brainmind.assess %>%
  filter(!is.na(rass.daily)) %>%
  group_by(id, study.day) %>%
  summarise(
    lowest_rass = min(rass.daily, na.rm = TRUE)
  ) %>%
  ungroup()

rass_for_auc <- brainmind.daily %>%
  left_join(low_rasses_res, by = c("id", "study.day")) %>%
  mutate(
    on_sedation = rcvd.benz | rcvd.op | rcvd.prop | rcvd.dex | rcvd.hal,
    ## xxx Combine with lowest bedside RASSes xxx
    ## Update: Decided to only use research staff RASS assessments
    ## For each patient-day, find lowest RASS
    # lowest_rass = case_when(
    #   !is.na(rass.low.icu) & rass.low.icu < rass.low.res ~ rass.low.icu,
    #   TRUE                                               ~ rass.low.res
    # ),
    ## Collapse all RASSes > 0 to 0
    ##  (very few; for our purposes they are equivalent)
    ## RASS distance, *all* hospital days
    rass_dist_total = if_else(
      lowest_rass > 0, 0, lowest_rass * -1, missing = as.numeric(NA)
    ),
    ## RASS distance, days patient received any sedating medication
    ##  (benzos, opioids, propofol, dex, haloperidol)
    rass_dist_sed = if_else(
      on_sedation, rass_dist_total, as.numeric(NA)
    )#,
    ## Keeping to reflect initial proposal, but decided that this was too
    ##  fraught with issues; see discussions on Slack
    ##  https://vumcicudelirium.slack.com/archives/C09D12EQL/p1540400730000100
    # ## RASS distance, days patient received benzodiazepines
    # rass_dist_benz = if_else(
    #   as.logical(rcvd.benz), rass_dist_total, as.numeric(NA)
    # ),
    # ## RASS distance, days patient received propofol
    # rass_dist_prop = if_else(
    #   as.logical(rcvd.prop), rass_dist_total, as.numeric(NA)
    # )
  ) %>%
  ## Days without mental status available and without sedation info available
  ##  are generally days patient was discharged/died (last days of
  ##  hospitalization)
  filter(id %in% ids_discharge, !is.na(lowest_rass)) %>%
  dplyr::select(
    id, study.day, on_sedation, lowest_rass, starts_with("rass_dist")
  )

## -- Exploration of RASSes for various subgroups, for original aims 3/4 -------
# ## How many ICU survivors only have one RASS?
# how_many_rasses <- rass_for_auc %>%
#   group_by(id) %>%
#   summarise_at(vars(starts_with("rass_dist")), ~ sum(!is.na(.))) %>%
#   ungroup() %>%
#   gather(key = rass_type, value = rass_number, starts_with("rass_dist")) %>%
#   mutate(rass_type = toupper(str_remove(rass_type, "rass_dist_")))
# 
# num_rasses_summary <- how_many_rasses %>%
#   group_by(rass_type, rass_number) %>%
#   count() %>%
#   filter(rass_number < 2) %>%
#   mutate(pct = n / length(ids_discharge))
# 
# ggplot(data = how_many_rasses) +
#   aes(x = rass_number) +
#   facet_wrap(~ rass_type) +
#   geom_histogram(binwidth = 1)

# rasses_while_benzo <- left_join(
#   brainmind.daily %>%
#     filter(rcvd.benz == 1) %>%
#     dplyr::select(id, study.day, rcvd.benz) %>%
#     ## Add counter for number of days
#     add_count(id),
#   brainmind.assess,
#   by = c("id", "study.day")
# ) %>%
#   ## Only interested in ICU survivors
#   filter(id %in% ids_discharge) %>%
#   ## How many assessments per day?
#   add_count(id, study.day)
# 
# ## How many had only one day with benzos, but two assessments on that day?
# rasses_added_benzo <- rasses_while_benzo %>%
#   filter(n == 1, nn == 2) %>%
#   pull(id) %>%
#   unique() %>%
#   length()

## Have to calculate AUCs separately for each cohort, because auc() fails with
##  <2 non-NA values (ie, patient has no days on sedation)
## Room for improvement: functionalize this

## Get IDs to include in each cohort
auc_total_ids <- rass_for_auc %>%
  filter(!is.na(rass_dist_total)) %>%
  group_by(id) %>% count() %>% filter(n > 1) %>% pull(id)

auc_sed_ids <- rass_for_auc %>%
  filter(!is.na(rass_dist_sed), !is.na(on_sedation)) %>%
  group_by(id) %>% count() %>% filter(n > 1) %>% pull(id)

## Calculate AUCs of each type
## All RASSes
auc_values_total <- rass_for_auc %>%
  filter(id %in% auc_total_ids) %>%
  group_by(id) %>%
  summarise(
    rass_auc_total = auc(x = study.day, y = rass_dist_total, rule = 2)
  ) %>%
  ungroup()

## RASSes while on sedation
auc_values_sed <- rass_for_auc %>%
  filter(id %in% auc_sed_ids) %>%
  group_by(id) %>%
  summarise(
    rass_auc_sed = auc(x = study.day, y = rass_dist_sed, rule = 2)
  ) %>%
  ungroup()

## -- Minor data management for baseline/hospital characteristics --------------
brainmind.oneobs <- brainmind.oneobs %>%
  mutate(
    race.comb = factor(
      case_when(
        is.na(race.pp)     ~ as.numeric(NA),
        race.pp == "White" ~ 0,
        TRUE               ~ 1
      ),
      levels = 0:1, labels = c("White", "Non-white")
    ),
    frailty.e = as.numeric(stringr::str_sub(frailty, 1, 1)),
    hosp.type = factor(
      as.numeric(id >= 14000), levels = 0:1, labels = c("Civilian", "Veteran")
    ),
    dc.facility = factor(
      as.numeric(!hospdis.loc == "Home"),
      levels = 0:1, labels = c("Home", "Facility")
    ),
    ## For covariates, patients who were never on MV need 0 imputed for vent LOS
    vent.los.all = ifelse(!is.na(vent.los.tot), vent.los.tot, 0)
  ) %>%
  ## Add on RASS AUCs (reduce() was throwing an error, no time for that today)
  left_join(auc_values_total, by = "id") %>%
  left_join(auc_values_sed, by = "id")

oneobs_covars <- c(
  "age.enroll", "sex.pp", "race.comb", "bmi", "edu", "charlson.score",
  "frailty.e", "faq.e", "hosp.type", "mean.modsofa.icu", "icudays.sevseptic.s",
  "vent.los.all", "hosp.los"
)

exposure_vars <- c("rass_auc_total", "rass_auc_sed")

outcome_vars <- c(
  "dc.facility",
  paste(c("adl", "faq", "sf36.pcs"), c(rep(3, 3), rep(12, 3)), sep = ".")
)

## -- Add outcome scores at each time point ------------------------------------
fu_subset <- brainmind.fu %>%
  filter(fu.period %in% paste(c(3, 12), "Month")) %>%
  dplyr::select(id, fu.period, adl.totscore, faq.totscore, sf36.pcs) %>%
  gather(key = test_name, value = test_score, -c(id, fu.period)) %>%
  mutate(
    fu.period = str_remove(fu.period, " Month"),
    test_name = str_remove(test_name, "\\.totscore")
  ) %>%
  unite(test_name, c(test_name, fu.period), sep = ".") %>%
  spread(key = test_name, value = test_score)

## -- Create datasets for patients, variables needed at each time point --------
df_full <- brainmind.oneobs %>% left_join(fu_subset, by = "id")

df_discharge <- df_full %>%
  filter(id %in% ids_discharge) %>%
  dplyr::select(id, one_of(oneobs_covars), dc.facility, one_of(exposure_vars))

df_3m <- df_full %>%
  filter(id %in% ids_3m) %>%
  dplyr::select(
    id,
    one_of(oneobs_covars),
    one_of(str_subset(names(fu_subset), "\\.3")),
    one_of(exposure_vars)
  )

df_12m <- df_full %>%
  filter(id %in% ids_12m) %>%
  dplyr::select(
    id,
    one_of(oneobs_covars),
    one_of(str_subset(names(fu_subset), "\\.12")),
    one_of(exposure_vars)
  )

```

The following analyses use data from the BRAIN-ICU and MIND-ICU cohorts to
examine the association between several measures of level of consciousness (LOC)
during critical illness and long-term disability, physical health-related
quality of life (pHRQOL), and mortality at 3 and 12 months following hospital discharge.

Throughout the analysis, level of consciousness (LOC) is measured using the Richmond Agitation-Sedation Scale (RASS). The RASS was performed by research
staff twice daily in the ICU and once daily outside the ICU during the
hospitalizations recorded in the parent studies. There are four exposures of
interest, each related to lowest daily RASS on days patients met specific
criteria.

# Study Aims

For all exposures, AUC is calculated using linear interpolation, with missing
values interpolated with the closest non-missing data point.

```{marginfigure, echo = TRUE}
**Exposure defintion, Aim 1:**

Area under the curve (AUC) of all lowest daily RASS's distance from 0 during hospitalization.

```

## Aim 1

We hypothesize that lower overall LOC during critical illness is associated with
greater disability and worsened physical health-related quality of life at 3 and
12 months after hospital discharge, after adjusting for other baseline and
hospitalization characteristics.

```{marginfigure, echo = TRUE}
**Exposure definition, Aim 2:**

Area under the curve (AUC) of all lowest daily RASS's distance from 0 on days
when patient received at least one of the following medications:
benzodiazepines; opioids; propofol; dexmedetomidine; haloperidol.

```

## Aim 2

We hypothesize that lower LOC **while patient is on sedating medications**
during critical illness is associated with greater disability and worsened
physical health-related quality of life at 3 and 12 months after hospital
discharge, after adjusting for other baseline and hospitalization characteristics.

We have considered looking specifically at benzodiazepine- and
propofol-associated level of consciousness; because a substantial number of
patients received these medications fewer than two days while hospitalized (and
thus cannot have an AUC calculated), this is not feasible to do with the same
strategies as Aims 1 & 2 while reliably adjusting for important confounders.
Work may be done on this area in the future.

## Outcome Definitions

For both aims, outcomes include the following, measured at 3 and 12 months
following hospital discharge:

- **Disability**
    - Katz Activities of Daily Living (ADL)
    - Pfeffer Functional Activities Questionnaire (FAQ)
    - Discharge destination (home vs facility)
- **Physical HRQOL**: Short Form-36 Physical Component Score (PCS)
- **Mortality**: Time to death within 365 days after study enrollment

# Statistical Methods

At each time point (hospital discharge, 3-month follow-up, and 12-month
follow-up), all patients will be included in analysis who were alive and not
officially withdrawn from the study.

## Model Choice

We will use the following types of multivariable regression to assess the
relationship between measures of LOC during hospitalization and each outcome
variable:

- Discharge location (home vs facility): logistic regression
- Katz ADL, Pfeffer FAQ: proportional odds logistic regression
- SF36 Physical Component Score: ordinary least squares (linear) regression
- Mortality at 90 and 365 days after enrollment: Cox proportional hazards regression

Model assumptions for each outcome and time point will be checked graphically.

## Model Covariates

All multivariable models will be adjusted for the following covariates:

- Baseline and ICU admission characteristics
    - Age
    - Sex
    - Race^[*(white vs other race)*]
    - BMI
    - Education
    - Charlson Comorbidity Index
    - CSHA Clinical Frailty Score at ICU admission
    - Pfeffer FAQ at ICU admission^[*forced to be linear; approximately 60% of patients had a 0 value, so splines would be somewhat unstable due to lack of variability*]
    - Hospital type^[*(civilian vs veteran)*]
- Hospitalization characteristics
    - Mean daily SOFA score, modified^[*(GCS not included, as it is directly calculated from our primary exposure)*]
    - Duration of severe sepsis/septic shock
    - Duration of mechanical ventilation
    - Hospital length of stay

All continuous variables will be allowed to have a nonlinear relationship with
the outcome unless noted above, using restricted cubic splines with three knots.
This results in a total of 22 degrees of freedom for covariates plus an additional 2df for exposure variables (total of 24 in each model).

<div class = 'marginnote plotlymargin'>
```{r miss_outcomes, fig.margin = TRUE, fig.cap = "% of Patients with Missing Outcomes, All RASSes", fig.width = 4, fig.height = 3}
missing_outcomes_total <- list(
  df_discharge %>% filter(id %in% auc_total_ids) %>% dplyr::select(dc.facility),
  df_3m %>% filter(id %in% auc_total_ids) %>% dplyr::select(one_of(outcome_vars)),
  df_12m %>% filter(id %in% auc_total_ids) %>% dplyr::select(one_of(outcome_vars))
) %>%
  map_df(miss_var_summary) %>%
  separate(variable, into = c("asmt", "timept"), sep = "\\.(?=\\d+$)") %>%
  mutate(
    asmt = case_when(
      asmt == "dc.facility" ~ "D/C Loc.",
      asmt == "sf36.pcs"    ~ "PCS",
      TRUE                  ~ toupper(asmt)
    ),
    asmt = fct_relevel(asmt, "D/C Loc.", after = 3L),
    timept = case_when(
      is.na(timept) ~ "D/C",
      TRUE ~ paste0(timept, "M")
    ),
    htext = glue("{n_miss} ({round(pct_miss)}%)")
  )

## Plotly won't stay in the margin?
plot_ly(
  missing_outcomes_total,
  x = ~ pct_miss,
  y = ~ asmt,
  text = ~ htext,
  color = ~ timept,
  type = "bar", orientation = "h", hoverinfo = "text",
  colors = c("#007471", "#003d74", "#000374")
) %>%
  layout(
    barmode = "dodge",
    xaxis = list(title = ""),
    yaxis = list(title = ""),
    legend = list(orientation = "h", traceorder = "reversed")
  )

```
</div>

<div class = 'marginnote plotlymargin'>
```{r miss_outcomes_sed, fig.margin = TRUE, fig.cap = "% of Patients with Missing Outcomes, RASSes on Sedation", fig.width = 4, fig.height = 3}
missing_outcomes_sed <- list(
  df_discharge %>% filter(id %in% auc_sed_ids) %>% dplyr::select(dc.facility),
  df_3m %>% filter(id %in% auc_sed_ids) %>% dplyr::select(one_of(outcome_vars)),
  df_12m %>% filter(id %in% auc_sed_ids) %>% dplyr::select(one_of(outcome_vars))
) %>%
  map_df(miss_var_summary) %>%
  separate(variable, into = c("asmt", "timept"), sep = "\\.(?=\\d+$)") %>%
  mutate(
    asmt = case_when(
      asmt == "dc.facility" ~ "D/C Loc.",
      asmt == "sf36.pcs"    ~ "PCS",
      TRUE                  ~ toupper(asmt)
    ),
    asmt = fct_relevel(asmt, "D/C Loc.", after = 3L),
    timept = case_when(
      is.na(timept) ~ "D/C",
      TRUE ~ paste0(timept, "M")
    ),
    htext = glue("{n_miss} ({round(pct_miss)}%)")
  )

## Plotly won't stay in the margin?
plot_ly(
  missing_outcomes_sed,
  x = ~ pct_miss,
  y = ~ asmt,
  text = ~ htext,
  color = ~ timept,
  type = "bar", orientation = "h", hoverinfo = "text",
  colors = c("#007471", "#003d74", "#000374")
) %>%
  layout(
    barmode = "dodge",
    xaxis = list(title = ""),
    yaxis = list(title = ""),
    legend = list(orientation = "h", traceorder = "reversed")
  )

```
</div>

## Missing Data

At each time point, all patients will be included in analysis who remained alive
and in the study and had at least two days of eligible RASS assessments. Missing
data for covariates (quite minimal; detailed below) and outcomes will be handled
using multiple imputation using predictive mean matching with `r n_imp`
imputations, using R's `Hmisc::aregImpute()` and `rms::fit.mult.impute()` functions. Proportions of eligible patients in each cohort with each outcome
data point available are shown to the right. The maximum amount missing
for any individual covariate at any time point is <2%. At hospital discharge, `r scales::percent(prop_miss_case(df_discharge %>% filter(id %in% auc_total_ids)))` of patients eligible for analysis using all RASSes are missing outcome or
covariate data; at 3-month follow-up, `r scales::percent(prop_miss_case(df_3m %>% filter(id %in% auc_total_ids)))` patients; and at 12-month follow-up,
`r scales::percent(prop_miss_case(df_12m %>% filter(id %in% auc_total_ids)))`. Using multiple imputation is particularly important for follow-up outcomes,
where we suspect that the patients who might have the worst outcomes are most prone to missingness.

```{r missing_data}
df_missing_total <- bind_rows(
  df_discharge %>% mutate(timept = "Hospital Discharge"),
  df_3m %>% mutate(timept = "3 Months"),
  df_12m %>% mutate(timept = "12 Months")
) %>%
  filter(id %in% auc_total_ids) %>%
  mutate(
    timept = forcats::fct_relevel(timept, "Hospital Discharge", "3 Months")
  ) %>%
  dplyr::select(timept, one_of(oneobs_covars), rass_auc_total)

df_missing_sed <- bind_rows(
  df_discharge %>% mutate(timept = "Hospital Discharge"),
  df_3m %>% mutate(timept = "3 Months"),
  df_12m %>% mutate(timept = "12 Months")
) %>%
  filter(id %in% auc_sed_ids) %>%
  mutate(
    timept = forcats::fct_relevel(timept, "Hospital Discharge", "3 Months")
  ) %>%
  dplyr::select(timept, one_of(oneobs_covars), rass_auc_sed)

```

<details><summary>Details of Missingness among Covariates</summary>

### All RASSes
```{r plot_missing_total, fig.fullwidth = TRUE}
miss_plot_total <- naniar::gg_miss_var(
  df_missing_total, timept, show_pct = TRUE
) +
  scale_y_continuous(name = "% Missing", limits = c(0, 5)) +
  geom_hline(yintercept = 5, colour = "gray50", linetype = "dotted") +
  theme(axis.title.y = element_blank())

ggplotly(miss_plot_total)

```

### RASSes while on Sedating Medication
```{r plot_missing_sed, fig.fullwidth = TRUE}
miss_plot_sed <- naniar::gg_miss_var(
  df_missing_sed, timept, show_pct = TRUE
) +
  scale_y_continuous(name = "% Missing", limits = c(0, 5)) +
  geom_hline(yintercept = 5, colour = "gray50", linetype = "dotted") +
  theme(axis.title.y = element_blank())

ggplotly(miss_plot_sed)

```

</details>

# Study Cohort

Analyses will include all ICU survivors who were alive and remained in the study
(ie, had not withdrawn) at the specified time point, and at least two RASS measurements meeting criteria. (If <2 RASS measurements were available, we could
not calculate the area under a curve.) Patients who died or officially withdrew from the study prior to assessment are not included in analyses at that time point. Missing data for individual assessments will be handled via multiple imputation.

**Note** that fewer patients will be included in models looking at levels of consciousness while patients received sedating medication, since not all
patients received those medications during the in-hospital study period.
Specific Ns will be included with each set of models.

### Patient Flow

```{r print_consort}
consort_info %>%
  dplyr::select(current, npct) %>%
  kable(
    format = "html", col.names = c("", "N (%)"), align = c("l", "r"),
    escape = FALSE
  ) %>%
  group_rows("Screening", 1, 7) %>%
  group_rows("In-Hospital", 8, 11) %>%
  group_rows("Three-Month Follow-Up", 12, 15) %>%
  group_rows("Twelve-Month Follow-Up", 16, 19) %>%
  row_spec(row = c(7, 11, 15, 19), bold = TRUE) %>%
  kable_styling(full_width = FALSE, position = "left")

```

### Description of the Cohorts

```{r describe_cohort}
## -- data.frame with variable labels to use for printing, summaries -----------
df_dc_labels <- df_full %>%
  filter(id %in% ids_discharge) %>%
  mutate(
    elig_3m = id %in% ids_3m,
    elig_12m = id %in% ids_12m
  )
label(df_dc_labels$age.enroll) <- "Age at enrollment"
label(df_dc_labels$sex.pp) <- "Sex"
label(df_dc_labels$race.comb) <- "Race category"
label(df_dc_labels$bmi) <- "BMI"
label(df_dc_labels$edu) <- "Years of education"
label(df_dc_labels$charlson.score) <- "Charlson Comorbidities Index"
label(df_dc_labels$frailty.e) <- "Clinical Frailty Score, enrollment"
label(df_dc_labels$adl.e) <- "Katz ADL, enrollment"
label(df_dc_labels$faq.e) <- "FAQ, enrollment"
label(df_dc_labels$hosp.type) <- "Hospital type"
label(df_dc_labels$num.apache) <- "APACHE II, enrollment"
label(df_dc_labels$sofa) <- "SOFA, enrollment"
label(df_dc_labels$icudays.sevseptic.s) <- "Days of severe sepsis"
label(df_dc_labels$vent.los.all) <- "Days on MV"
label(df_dc_labels$del.s.imp) <- "Days of delirium"
label(df_dc_labels$coma.s.imp) <- "Days of coma"
label(df_dc_labels$delcoma.s.imp) <- "Days of delirium/coma"
label(df_dc_labels$mean.modsofa.icu) <- "Mean modified SOFA"
label(df_dc_labels$rass_auc_total) <- "RASS AUC, all days"
label(df_dc_labels$rass_auc_sed) <- "RASS AUC, days on sedation"
label(df_dc_labels$icu.los.tot) <- "ICU length of stay"
label(df_dc_labels$hosp.los) <- "Hospital length of stay"
label(df_dc_labels$dc.facility) <- "Discharge location"
label(df_dc_labels$died.study.365) <- "Status, 365 days after enrollment"
label(df_dc_labels$adl.3) <- "Katz ADL, 3m"
label(df_dc_labels$faq.3) <- "FAQ, 3m"
label(df_dc_labels$sf36.pcs.3) <- "SF36 PCS, 3m"
label(df_dc_labels$adl.12) <- "Katz ADL, 12m"
label(df_dc_labels$faq.12) <- "FAQ, 12m"
label(df_dc_labels$sf36.pcs.12) <- "SF36 PCS, 12m"

## For now, just describe patients eligible for discharge to facility
html(
  summaryM(
    age.enroll + sex.pp + race.comb + bmi + edu + charlson.score + frailty.e +
      adl.e + faq.e + hosp.type + num.apache + sofa + icudays.sevseptic.s +
      vent.los.all + del.s.imp + coma.s.imp + delcoma.s.imp + icu.los.tot +
      hosp.los + dc.facility + died.study.365 ~ 1,
     data = df_dc_labels,
     continuous = 5
  ),
  prmsd = TRUE,
  digits = 2,
  what = "%",
  npct = "both",
  exclude1 = FALSE, long = TRUE,
  caption = "Baseline and Hospitalization Characteristics, Patients Eligible for Analysis at Discharge"
)

```

### Description of Outcomes

```{r describe_3m}
html(
  summaryM(
    as.formula(paste(
      paste(str_subset(outcome_vars, "\\.3$"), collapse = " + "),
      "~ 1"
    )),
    data = df_dc_labels %>% filter(elig_3m),
    continuous = 5
  ),
  prmsd = TRUE,
  digits = 2,
  what = "%",
  npct = "both",
  exclude1 = FALSE, long = TRUE,
  caption = "Outcomes of Interest, 3-Month Follow-Up"
)

```

```{r describe_12m}
html(
  summaryM(
    as.formula(paste(
      paste(str_subset(outcome_vars, "\\.12$"), collapse = " + "),
      "~ 1"
    )),
    data = df_dc_labels %>% filter(elig_12m),
    continuous = 5
  ),
  prmsd = TRUE,
  digits = 2,
  what = "%",
  npct = "both",
  exclude1 = FALSE, long = TRUE,
  caption = "Outcomes of Interest, 12-Month Follow-Up"
)

```

```{r model_prep, message = FALSE, results = "hide"}
## -- Multiple imputation at each time point -----------------------------------
## Don't bother with hospital discharge; <2% missing

## Separate imputation for two exposures (also have different Ns, since not
##   everyone was on sedation)
set.seed(56)
areg_total_3 <- aregImpute(
  ~ sf36.pcs.3 + mean.modsofa.icu +
    icudays.sevseptic.s + bmi + rass_auc_total + age.enroll + sex.pp +
    race.comb + charlson.score + frailty.e + hosp.type + vent.los.all +
    hosp.los + I(faq.3) + I(adl.3) + edu + I(faq.e),
    ## FAQ, ADL have too many zeros/too few others to reliably allow for knots
  data = df_3m,
  nk = 3,
  n.impute = n_imp
)

set.seed(56)
areg_sed_3 <- aregImpute(
  ~ sf36.pcs.3 + mean.modsofa.icu +
    icudays.sevseptic.s + bmi + rass_auc_sed + age.enroll + sex.pp +
    race.comb + charlson.score + frailty.e + hosp.type + vent.los.all +
    hosp.los + I(faq.3) + I(adl.3) + edu + I(faq.e),
    ## FAQ, ADL have too many zeros/too few others to reliably allow for knots
  data = subset(df_3m, !is.na(rass_auc_sed)),
  nk = 3,
  n.impute = n_imp
)

set.seed(56)
areg_total_12 <- aregImpute(
  ~ sf36.pcs.12 + mean.modsofa.icu +
    icudays.sevseptic.s + bmi + rass_auc_total + age.enroll + sex.pp +
    race.comb + charlson.score + frailty.e + hosp.type + vent.los.all +
    hosp.los + I(faq.12) + I(adl.12) + edu + I(faq.e),
    ## FAQ, ADL have too many zeros/too few others to reliably allow for knots
  data = df_12m,
  nk = 3,
  n.impute = n_imp
)

set.seed(56)
areg_sed_12 <- aregImpute(
  ~ sf36.pcs.12 + mean.modsofa.icu +
    icudays.sevseptic.s + bmi + rass_auc_sed + age.enroll + sex.pp +
    race.comb + charlson.score + frailty.e + hosp.type + vent.los.all +
    hosp.los + I(faq.12) + I(adl.12) + edu + I(faq.e),
    ## FAQ, ADL have too many zeros/too few others to reliably allow for knots
  data = subset(df_12m, !is.na(rass_auc_sed)),
  nk = 3,
  n.impute = n_imp
)

set.seed(56)
areg_total_death <- aregImpute(
  ~ sf36.pcs.3 + sf36.pcs.12 + mean.modsofa.icu +
    icudays.sevseptic.s + bmi + rass_auc_total + age.enroll + sex.pp +
    race.comb + charlson.score + frailty.e + hosp.type + vent.los.all +
    hosp.los + I(faq.3) + I(adl.3) + edu + I(faq.e) + I(faq.12) + I(adl.12),
    ## FAQ, ADL have too many zeros/too few others to reliably allow for knots
  data = df_full %>% filter(id %in% ids_discharge),
  nk = 3,
  n.impute = n_imp
)

set.seed(56)
areg_sed_death <- aregImpute(
  ~ sf36.pcs.3 + sf36.pcs.12 + mean.modsofa.icu +
    icudays.sevseptic.s + bmi + rass_auc_sed + age.enroll + sex.pp +
    race.comb + charlson.score + frailty.e + hosp.type + vent.los.all +
    hosp.los + I(faq.3) + I(adl.3) + edu + I(faq.e) + I(faq.12) + I(adl.12),
    ## FAQ, ADL have too many zeros/too few others to reliably allow for knots
  data = df_full %>% filter(id %in% ids_discharge & !is.na(rass_auc_sed)),
  nk = 3,
  n.impute = n_imp
)

set.seed(56)
areg_total_dcloc <- aregImpute(
  ~ sf36.pcs.3 + sf36.pcs.12 + mean.modsofa.icu + dc.facility +
    icudays.sevseptic.s + bmi + rass_auc_total + age.enroll + sex.pp +
    race.comb + charlson.score + frailty.e + hosp.type + vent.los.all +
    hosp.los + I(faq.3) + I(adl.3) + edu + I(faq.e) + I(faq.12) + I(adl.12),
    ## FAQ, ADL have too many zeros/too few others to reliably allow for knots
  data = df_full %>% filter(id %in% ids_discharge),
  nk = 3,
  n.impute = n_imp
)

set.seed(56)
areg_sed_dcloc <- aregImpute(
  ~ sf36.pcs.3 + sf36.pcs.12 + mean.modsofa.icu + dc.facility +
    icudays.sevseptic.s + bmi + rass_auc_sed + age.enroll + sex.pp +
    race.comb + charlson.score + frailty.e + hosp.type + vent.los.all +
    hosp.los + I(faq.3) + I(adl.3) + edu + I(faq.e) + I(faq.12) + I(adl.12),
    ## FAQ, ADL have too many zeros/too few others to reliably allow for knots
  data = df_full %>% filter(id %in% ids_discharge & !is.na(rass_auc_sed)),
  nk = 3,
  n.impute = n_imp
)

## Character string for RHS of models
##  "rassvar" will be replaced with exposure of interest
model_rhs <- "rcs(age.enroll, 3) + sex.pp + race.comb + rcs(bmi, 3) + rcs(edu, 3) + rcs(charlson.score, 3) + rcs(frailty.e, 3) + faq.e + hosp.type + rcs(mean.modsofa.icu, 3) + rcs(icudays.sevseptic.s, 3) + rcs(vent.los.all, 3) + rcs(hosp.los, 3) + rcs(rassvar, 3)"

##  12m mortality doesn't have enough events to support all these splines
model_death_rhs <- "rcs(age.enroll, 3) + sex.pp + race.comb + bmi + edu + charlson.score + frailty.e + faq.e + hosp.type + mean.modsofa.icu + icudays.sevseptic.s + vent.los.all + hosp.los + rcs(rassvar, 3)"

## -- Function: Replace `rassvar` w/ specific exp (eg, `rass_auc_total`) -------
## Built to work with `model_rhs`, but should work with any character string
##  that includes `rassvar`
replace_rass <- function(repvar, x = model_rhs){
  str_replace_all(x, "rassvar", repvar)
}

## Example:
# replace_rass(repvar = "rass_auc_total")

## Set up for mapping to get models, results
## Both exposures at 3m, then both exposures at 12m
expvars <- rep(c("rass_auc_total", "rass_auc_sed"), 2)
timepts <- rep(c(3, 12), each = 2)
df_list <- list(
  df_3m, subset(df_3m, !is.na(rass_auc_sed)),
  df_12m, subset(df_12m, !is.na(rass_auc_sed))
)
areg_list <- list(areg_total_3, areg_sed_3, areg_total_12, areg_sed_12)

## Use same datadist (all ICU survivors) for each model
dd <- datadist(df_discharge); options(datadist = "dd")

```

# Discharge Location

```{r dcloc_distribution, fig.margin = TRUE, fig.cap = "Distribution of Discharge Locations", fig.width = 4, fig.height = 5}
ggplot(data = df_discharge, aes(x = dc.facility)) +
  geom_bar() +
  labs(
    x = "Discharge Location", y = "Frequency"
  )

```

After adjusting for covariates, we see a possible directional relationship
between deeper levels of consciousness during hospitalization and higher odds of
worse long-term disability; however, this association is weak. There are relatively few ICU survivors who lack independence (scores > 0) per the Katz ADL
*(see side)* - `r scales::percent(mean(df_3m$adl.3 == 0, na.rm = TRUE))` at 3m and `r scales::percent(mean(df_12m$adl.12 == 0, na.rm = TRUE))` at 12m have zero scores, or full independence, with the rest of the scores spread across the rest of the distribution - which makes detecting a weak association difficult.

Models for this outcome were proportional odds logistic regression; the results
shown below are the odds of a higher vs lower score on the Katz ADL for the 75th
percentile of the AUC measurement vs the 25th percentile. Because these
associations are nonlinear, the predicted probability plots below give a better
overall picture. These probabilities are adjusted to the median or mode of all
covariates, showing the probability of a higher ADL score for otherwise
identical patients with varying AUC values.

```{r models_dcloc, results = "hide"}
fit_polr <- function(outcome, exposure, df, aregobj){
  fit.mult.impute(
    as.formula(paste(outcome, "~", replace_rass(exposure))),
    fitter = lrm,
    data = df,
    xtrans = aregobj
  )
}

models_dcloc <- pmap(
  .l = list(
    outcome = rep("dc.facility", 2),
    exposure = expvars[1:2],
    df = list(
      df_full %>% filter(id %in% ids_discharge),
      df_full %>% filter(id %in% ids_discharge & !is.na(rass_auc_sed))
    ),
    aregobj = list(areg_total_dcloc, areg_sed_dcloc)
  ),
  .f = fit_polr
)

## Data frames of full model results
results_dcloc <- map(models_dcloc, rms_model_results2, labeldf = df_dc_labels)

## Extract odds ratios for RASS AUCs for cleaner table
rass_est_dcloc <- map_df(
  results_dcloc,
  ~ filter(., str_detect(.$label, "^RASS"))
) %>%
  set_names(str_replace(names(.), "label", "exposure")) %>%
  mutate(
    outcome = "Discharge Location",
    est_nums = str_remove_all(est.ci, "\\(|\\)|,"),
    exposure = capitalize(str_remove(exposure, "^RASS AUC, "))
  ) %>%
  separate(
    est_nums,
    into = c("est", "lcl", "ucl"),
    sep = " "
  )
  
## Data frames of predicted probabilities (P("higher ADL"))
## This loop pains me. I couldn't get map() to work on the deadline; it looked
##  like some weirdness due to multiple things being called .x? 🤷
pred_dcloc <- vector("list", length = length(models_dcloc))
for(i in 1:length(pred_dcloc)){
  tmp <- eval(
    parse(
      text = sprintf(
        "Predict(models_dcloc[[i]], %s = NA, fun = plogis)", expvars[i]
      )
    )
  )
  
  pred_dcloc[[i]] <- as.data.frame(tmp) %>%
    mutate(
      outcome = "Discharge Location",
      exposure = expvars[i],
      timept = timepts[i],
      xvar = .[[expvars[i]]]
    )
}

## Combine into a single dataset for plotting
pred_df_dcloc <- bind_rows(pred_dcloc) %>%
  mutate(
    exposure = factor(
      ifelse(exposure == "rass_auc_sed", 1, 0),
      levels = 0:1, labels = c("All RASSes", "RASSes on Sedating Medications")
    )
  )

```

```{r results_dcloc}
kable(
  rass_est_dcloc %>%
    arrange(exposure) %>%
    dplyr::select(est.ci, pval),
  format = "html",
  caption = "Level of Consciousness vs Discharge to Facility",
  col.names = c("Odds Ratio (95% CI), 75th vs 25th %ile", "P"),
  align = c("r", "r")
) %>%
  group_rows(index = c("All RASSes" = 1, "RASSes while on sedation" = 1))

```

```{r plot_dcloc}
ggplot(data = pred_df_dcloc) +
  aes(x = xvar, y = yhat) +
  geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.4) +
  geom_line() +
  facet_wrap(~ exposure, nrow = 1) +
  scale_y_continuous(limits = 0:1) +
  labs(
    x = "Area Under the Curve",
    y = "Probability of Discharge to Facility"
  )

```

<details><summary>Full Model Results</summary>

### AUC, All RASSes vs Discharge Location

```{r dcloc_total}
kable(
  results_dcloc[[1]],
  format = "html",
  col.names = c("Covariate", "Ref.", "Comp.", "OR (95% CI)", "X2", "df", "P"),
  align = c("l", rep("r", ncol(results_dcloc[[1]]) - 1))
)

```

### AUC, RASSes on Sedating Medications vs Discharge Location

```{r dcloc_sed}
kable(
  results_dcloc[[2]],
  format = "html",
  col.names = c("Covariate", "Ref.", "Comp.", "OR (95% CI)", "X2", "df", "P"),
  align = c("l", rep("r", ncol(results_dcloc[[1]]) - 1))
)

```

# Activities of Daily Living

```{r adl_distribution, fig.margin = TRUE, fig.cap = "Distribution of Katz ADL Scores", fig.width = 4, fig.height = 5}
bind_rows(
  df_3m %>%
    mutate(timept = "3M") %>%
    dplyr::select(id, timept, adl.3) %>%
    set_names(str_remove(names(.), "\\.[0-9]+$")),
  df_12m %>%
    mutate(timept = "12M") %>%
    dplyr::select(id, timept, adl.12) %>%
    set_names(str_remove(names(.), "\\.[0-9]+$"))
) %>%
  mutate(timept = factor(timept, levels = c("3M", "12M"))) %>%
  ggplot(aes(x = adl)) +
    facet_wrap(~ timept, ncol = 1) +
    geom_histogram() +
    labs(
      x = "Katz ADL Score", y = "Frequency"
    )

```

After adjusting for covariates, we see a possible directional relationship
between deeper levels of consciousness during hospitalization and higher odds of
worse long-term disability; however, this association is weak. There are relatively few ICU survivors who lack independence (scores > 0) per the Katz ADL
*(see side)* - `r scales::percent(mean(df_3m$adl.3 == 0, na.rm = TRUE))` at 3m and `r scales::percent(mean(df_12m$adl.12 == 0, na.rm = TRUE))` at 12m have zero scores, or full independence, with the rest of the scores spread across the rest of the distribution - which makes detecting a weak association difficult.

Models for this outcome were proportional odds logistic regression; the results
shown below are the odds of a higher vs lower score on the Katz ADL for the 75th
percentile of the AUC measurement vs the 25th percentile. Because these
associations are nonlinear, the predicted probability plots below give a better
overall picture. These probabilities are adjusted to the median or mode of all
covariates, showing the probability of a higher ADL score for otherwise
identical patients with varying AUC values.

```{r models_adl, results = "hide"}
fit_polr <- function(outcome, exposure, df, aregobj){
  fit.mult.impute(
    as.formula(paste(outcome, "~", replace_rass(exposure))),
    fitter = lrm,
    data = df,
    xtrans = aregobj
  )
}

models_adl <- pmap(
  .l = list(
    outcome = paste0("adl.", timepts),
    exposure = expvars,
    df = df_list,
    aregobj = areg_list
  ),
  .f = fit_polr
)

## Data frames of full model results
results_adl <- map(models_adl, rms_model_results2, labeldf = df_dc_labels) %>%
  ## Don't want N for every single level of ADL; quick and dirty, oops
  map(~ slice(., 1:22))

## Extract odds ratios for RASS AUCs for cleaner table
rass_est_adl <- map_df(
  results_adl,
  ~ filter(., str_detect(.$label, "^RASS"))
) %>%
  set_names(str_replace(names(.), "label", "exposure")) %>%
  mutate(
    timept = paste0(timepts, "M"),
    outcome = "Katz ADL",
    est_nums = str_remove_all(est.ci, "\\(|\\)|,"),
    exposure = capitalize(str_remove(exposure, "^RASS AUC, "))
  ) %>%
  separate(
    est_nums,
    into = c("est", "lcl", "ucl"),
    sep = " "
  )
  
## Data frames of predicted probabilities (P("higher ADL"))
## This loop pains me. I couldn't get map() to work on the deadline; it looked
##  like some weirdness due to multiple things being called .x? 🤷
pred_adl <- vector("list", length = length(models_adl))
for(i in 1:length(pred_adl)){
  tmp <- eval(
    parse(
      text = sprintf(
        "Predict(models_adl[[i]], %s = NA, fun = plogis)", expvars[i]
      )
    )
  )
  
  pred_adl[[i]] <- as.data.frame(tmp) %>%
    mutate(
      outcome = "Katz ADL",
      exposure = expvars[i],
      timept = timepts[i],
      xvar = .[[expvars[i]]]
    )
}

## Combine into a single dataset for plotting
pred_df_adl <- bind_rows(pred_adl) %>%
  mutate(
    timept = factor(paste0(timept, "M"), levels = c("3M", "12M")),
    exposure = factor(
      ifelse(exposure == "rass_auc_sed", 1, 0),
      levels = 0:1, labels = c("All RASSes", "RASSes on Sedating Medications")
    )
  )

```

```{r results_adl}
kable(
  rass_est_adl %>%
    arrange(exposure) %>%
    dplyr::select(timept, est.ci, pval),
  format = "html",
  caption = "Level of Consciousness vs Katz ADL",
  col.names = c(
    "Months after Discharge",
    "Odds Ratio (95% CI), 75th vs 25th %ile",
    "P"
  ),
  align = c("c", "r", "r")
) %>%
  group_rows(index = c("All RASSes" = 2, "RASSes while on sedation" = 2))

```

```{r plot_adl}
ggplot(data = pred_df_adl) +
  aes(x = xvar, y = yhat) +
  geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.4) +
  geom_line() +
  facet_grid(exposure ~ timept) +
  scale_y_continuous(limits = 0:1) +
  labs(
    x = "Area Under the Curve",
    y = "Probability of Higher ADL Score"
  )

```

<details><summary>Full Model Results</summary>

### AUC, All RASSes vs ADL, 3m

```{r adl_total_3m}
kable(
  results_adl[[1]],
  format = "html",
  col.names = c("Covariate", "Ref.", "Comp.", "OR (95% CI)", "X2", "df", "P"),
  align = c("l", rep("r", ncol(results_adl[[1]]) - 1))
)

```

### AUC, All RASSes vs ADL, 12m

```{r adl_total_12m}
kable(
  results_adl[[3]],
  format = "html",
  col.names = c("Covariate", "Ref.", "Comp.", "OR (95% CI)", "X^2^", "df", "P"),
  align = c("l", rep("r", ncol(results_adl[[1]]) - 1))
)

```

### AUC, RASSes on Sedating Medications vs ADL, 3m

```{r adl_sed_3m}
kable(
  results_adl[[2]],
  format = "html",
  col.names = c("Covariate", "Ref.", "Comp.", "OR (95% CI)", "X2", "df", "P"),
  align = c("l", rep("r", ncol(results_adl[[1]]) - 1))
)

```

### AUC, RASSes on Sedating Medications vs ADL, 12m

```{r adl_sed_12m}
kable(
  results_adl[[4]],
  format = "html",
  col.names = c("Covariate", "Ref.", "Comp.", "OR (95% CI)", "X2", "df", "P"),
  align = c("l", rep("r", ncol(results_adl[[1]]) - 1))
)

```

</details>

# Functional Activities Questionnaire

```{r faq_distribution, fig.margin = TRUE, fig.cap = "Distribution of FAQ Scores", fig.width = 4, fig.height = 5}
bind_rows(
  df_3m %>%
    mutate(timept = "3M") %>%
    dplyr::select(id, timept, faq.3) %>%
    set_names(str_remove(names(.), "\\.[0-9]+$")),
  df_12m %>%
    mutate(timept = "12M") %>%
    dplyr::select(id, timept, faq.12) %>%
    set_names(str_remove(names(.), "\\.[0-9]+$"))
) %>%
  mutate(timept = factor(timept, levels = c("3M", "12M"))) %>%
  ggplot(aes(x = faq)) +
    facet_wrap(~ timept, ncol = 1) +
    geom_histogram() +
    labs(
      x = "FAQ Score", y = "Frequency"
    )

```

After adjusting for covariates, we see a directional relationship between deeper
levels of consciousness during hospitalization and higher odds of worse
long-term disability; the association between total level of consciousness and
FAQ scores at 12 months following discharge reaches statistical significance.

Models for this outcome were proportional odds logistic regression; the results
shown below are the odds of a higher vs lower score on the FAQ for the 75th
percentile of the AUC measurement vs the 25th percentile. Because these
associations are nonlinear, the predicted probability plots below give a better
overall picture. These probabilities are adjusted to the median or mode of all
covariates, showing the probability of a higher FAQ score for otherwise
identical patients with varying AUC values.

```{r models_faq, results = "hide"}
models_faq <- pmap(
  .l = list(
    outcome = paste0("faq.", timepts),
    exposure = expvars,
    df = df_list,
    aregobj = areg_list
  ),
  .f = fit_polr
)

## Data frames of full model results
results_faq <- map(models_faq, rms_model_results2, labeldf = df_dc_labels) %>%
  ## Don't want N for every single level of FAQ; quick and dirty, oops
  map(~ slice(., 1:22))

## Extract odds ratios for RASS AUCs for cleaner table
rass_est_faq <- map_df(
  results_faq,
  ~ filter(., str_detect(.$label, "^RASS"))
) %>%
  set_names(str_replace(names(.), "label", "exposure")) %>%
  mutate(
    timept = paste0(timepts, "M"),
    outcome = "FAQ",
    est_nums = str_remove_all(est.ci, "\\(|\\)|,"),
    exposure = capitalize(str_remove(exposure, "^RASS AUC, "))
  ) %>%
  separate(
    est_nums,
    into = c("est", "lcl", "ucl"),
    sep = " "
  )
  
## Data frames of predicted probabilities (P("higher FAQ"))
## This loop pains me. I couldn't get map() to work on the deadline; it looked
##  like some weirdness due to multiple things being called .x? 🤷
pred_faq <- vector("list", length = length(models_faq))
for(i in 1:length(pred_faq)){
  tmp <- eval(
    parse(
      text = sprintf(
        "Predict(models_faq[[i]], %s = NA, fun = plogis)", expvars[i]
      )
    )
  )
  
  pred_faq[[i]] <- as.data.frame(tmp) %>%
    mutate(
      outcome = "FAQ",
      exposure = expvars[i],
      timept = timepts[i],
      xvar = .[[expvars[i]]]
    )
}

## Combine into a single dataset for plotting
pred_df_faq <- bind_rows(pred_faq) %>%
  mutate(
    timept = factor(paste0(timept, "M"), levels = c("3M", "12M")),
    exposure = factor(
      ifelse(exposure == "rass_auc_sed", 1, 0),
      levels = 0:1, labels = c("All RASSes", "RASSes on Sedating Medications")
    )
  )

```

```{r results_faq}
kable(
  rass_est_faq %>%
    arrange(exposure) %>%
    dplyr::select(timept, est.ci, pval),
  format = "html",
  caption = "Level of Consciousness vs FAQ",
  col.names = c(
    "Months after Discharge",
    "Odds Ratio (95% CI), 75th vs 25th %ile",
    "P"
  ),
  align = c("c", "r", "r")
) %>%
  group_rows(index = c("All RASSes" = 2, "RASSes while on sedation" = 2))

```

```{r plot_faq}
ggplot(data = pred_df_faq) +
  aes(x = xvar, y = yhat) +
  geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.4) +
  geom_line() +
  facet_grid(exposure ~ timept) +
  scale_y_continuous(limits = 0:1) +
  labs(
    x = "Area Under the Curve",
    y = "Probability of Higher FAQ Score"
  )

```

<details><summary>Full Model Results</summary>

### AUC, All RASSes vs FAQ, 3m

```{r faq_total_3m}
kable(
  results_faq[[1]],
  format = "html",
  col.names = c("Covariate", "Ref.", "Comp.", "OR (95% CI)", "X2", "df", "P"),
  align = c("l", rep("r", ncol(results_adl[[1]]) - 1))
)

```

### AUC, All RASSes vs FAQ, 12m

```{r faq_total_12m}
kable(
  results_faq[[3]],
  format = "html",
  col.names = c("Covariate", "Ref.", "Comp.", "OR (95% CI)", "X^2^", "df", "P"),
  align = c("l", rep("r", ncol(results_adl[[1]]) - 1))
)

```

### AUC, RASSes on Sedating Medications vs FAQ, 3m

```{r faq_sed_3m}
kable(
  results_faq[[2]],
  format = "html",
  col.names = c("Covariate", "Ref.", "Comp.", "OR (95% CI)", "X2", "df", "P"),
  align = c("l", rep("r", ncol(results_adl[[1]]) - 1))
)

```

### AUC, RASSes on Sedating Medications vs FAQ, 12m

```{r faq_sed_12m}
kable(
  results_faq[[4]],
  format = "html",
  col.names = c("Covariate", "Ref.", "Comp.", "OR (95% CI)", "X2", "df", "P"),
  align = c("l", rep("r", ncol(results_adl[[1]]) - 1))
)

```

</details>

# SF36 Physical Component Score

```{r pcs_distribution, fig.margin = TRUE, fig.cap = "Distribution of SF36 Physical Component Scores", fig.width = 4, fig.height = 5}
bind_rows(
  df_3m %>%
    mutate(timept = "3M") %>%
    dplyr::select(id, timept, sf36.pcs.3) %>%
    set_names(str_remove(names(.), "\\.[0-9]+$")),
  df_12m %>%
    mutate(timept = "12M") %>%
    dplyr::select(id, timept, sf36.pcs.12) %>%
    set_names(str_remove(names(.), "\\.[0-9]+$"))
) %>%
  mutate(timept = factor(timept, levels = c("3M", "12M"))) %>%
  ggplot(aes(x = sf36.pcs)) +
    facet_wrap(~ timept, ncol = 1) +
    geom_histogram() +
    labs(
      x = "SF36 PCS", y = "Frequency"
    )

```

After adjusting for covariates, we see no consistent or strong relationship
between level of consciousness and SF36 physical component scores.

Models for this outcome were linear regression; the results shown below are the
difference, on average, in SF36 physical component scores for the 75th
percentile of the AUC measurement vs the 25th percentile. Because these
associations are nonlinear, the marginal effects plots below give a better
overall picture. These predictions are adjusted to the median or mode of all
covariates, showing the predicted SF36 PCS for otherwise identical patients with
varying AUC values.

```{r models_pcs, results = "hide"}
fit_ols <- function(outcome, exposure, df, aregobj){
  fit.mult.impute(
    as.formula(paste(outcome, "~", replace_rass(exposure))),
    fitter = ols,
    data = df,
    xtrans = aregobj
  )
}

models_pcs <- pmap(
  .l = list(
    outcome = paste0("sf36.pcs.", timepts),
    exposure = expvars,
    df = df_list,
    aregobj = areg_list
  ),
  .f = fit_ols
)

## Data frames of full model results
results_pcs <- map(models_pcs, rms_model_results2, labeldf = df_dc_labels)

## Extract differences for RASS AUCs for cleaner table
rass_est_pcs <- map_df(
  results_pcs,
  ~ filter(., str_detect(.$label, "^RASS"))
) %>%
  set_names(str_replace(names(.), "label", "exposure")) %>%
  mutate(
    timept = paste0(timepts, "M"),
    outcome = "SF36 PCS",
    est_nums = str_remove_all(est.ci, "\\(|\\)|,"),
    exposure = capitalize(str_remove(exposure, "^RASS AUC, "))
  ) %>%
  separate(
    est_nums,
    into = c("est", "lcl", "ucl"),
    sep = " "
  )
  
## Data frames of predicted values
## This loop pains me. I couldn't get map() to work on the deadline; it looked
##  like some weirdness due to multiple things being called .x? 🤷
pred_pcs <- vector("list", length = length(models_pcs))
for(i in 1:length(pred_pcs)){
  tmp <- eval(
    parse(text = sprintf("Predict(models_pcs[[i]], %s = NA)", expvars[i]))
  )
  
  pred_pcs[[i]] <- as.data.frame(tmp) %>%
    mutate(
      outcome = "SF36 PCS",
      exposure = expvars[i],
      timept = timepts[i],
      xvar = .[[expvars[i]]]
    )
}

## Combine into a single dataset for plotting
pred_df_pcs <- bind_rows(pred_pcs) %>%
  mutate(
    timept = factor(paste0(timept, "M"), levels = c("3M", "12M")),
    exposure = factor(
      ifelse(exposure == "rass_auc_sed", 1, 0),
      levels = 0:1, labels = c("All RASSes", "RASSes on Sedating Medications")
    )
  )

```

```{r results_pcs}
kable(
  rass_est_pcs %>%
    arrange(exposure) %>%
    dplyr::select(timept, est.ci, pval),
  format = "html",
  caption = "Level of Consciousness vs SF36 PCS",
  col.names = c(
    "Months after Discharge",
    "Difference (95% CI), 75th vs 25th %ile",
    "P"
  ),
  align = c("c", "r", "r")
) %>%
  group_rows(index = c("All RASSes" = 2, "RASSes while on sedation" = 2))

```

```{r plot_pcs}
ggplot(data = pred_df_pcs) +
  aes(x = xvar, y = yhat) +
  geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.4) +
  geom_line() +
  facet_grid(exposure ~ timept) +
  labs(
    x = "Area Under the Curve",
    y = "Predicted Physical Component Score"
  )

```

<details><summary>Full Model Results</summary>

### AUC, All RASSes vs SF36 PCS, 3m

```{r pcs_total_3m}
kable(
  results_pcs[[1]],
  format = "html",
  col.names = c("Covariate", "Ref.", "Comp.", "Diff. (95% CI)", "F", "df", "P"),
  align = c("l", rep("r", ncol(results_adl[[1]]) - 1))
)

```

### AUC, All RASSes vs SF36 PCS, 12m

```{r pcs_total_12m}
kable(
  results_pcs[[3]],
  format = "html",
  col.names = c("Covariate", "Ref.", "Comp.", "Diff. (95% CI)", "F", "df", "P"),
  align = c("l", rep("r", ncol(results_adl[[1]]) - 1))
)

```

### AUC, RASSes on Sedating Medications vs SF36 PCS, 3m

```{r pcs_sed_3m}
kable(
  results_pcs[[2]],
  format = "html",
  col.names = c("Covariate", "Ref.", "Comp.", "Diff. (95% CI)", "F", "df", "P"),
  align = c("l", rep("r", ncol(results_adl[[1]]) - 1))
)

```

### AUC, RASSes on Sedating Medications vs SF36 PCS, 12m

```{r pcs_sed_12m}
kable(
  results_pcs[[4]],
  format = "html",
  col.names = c("Covariate", "Ref.", "Comp.", "Diff. (95% CI)", "F", "df", "P"),
  align = c("l", rep("r", ncol(results_adl[[1]]) - 1))
)

```

</details>

# 12-Month Mortality

After adjusting for covariates^[*NOTE: Due to the number of deaths, we were unable to include nonlinear terms in these models for covariates other than LOC and age*], we see no meaningful relationship between deeper levels of consciousness during hospitalization and rate of mortality within 12
months of study enrollment.

Models for this outcome were Cox proportional hazards regression; the results
shown below are the ratio of hazard of death at a given time point for the 75th
percentile of the AUC measurement vs the 25th percentile.

```{r models_death, results = "hide"}
fit_cph <- function(outcome, exposure, df, aregobj){
  fit.mult.impute(
    as.formula(paste(outcome, "~", replace_rass(exposure, model_death_rhs))),
    fitter = cph,
    data = df,
    xtrans = aregobj
  )
}

## Create Surv objects
surv_all <- with(subset(df_full, id %in% ids_discharge), {
  Surv(
    time = days.deathlast.365,
    event = (died.study.365 == "Died during first 365 days")
  )
})

surv_sed <-
  with(subset(df_full, id %in% ids_discharge & !is.na(rass_auc_sed)), {
    Surv(
      time = days.deathlast.365,
      event = (died.study.365 == "Died during first 365 days")
    )
  })

models_death <- pmap(
  .l = list(
    outcome = c("surv_all", "surv_sed"),
    exposure = expvars[1:2],
    df = list(
      df_full %>% filter(id %in% ids_discharge),
      df_full %>% filter(id %in% ids_discharge & !is.na(rass_auc_sed))
    ),
    aregobj = list(areg_total_death, areg_sed_death)
  ),
  .f = fit_cph
)

## Data frames of full model results
results_death <- map(models_death, rms_model_results2, labeldf = df_dc_labels)

## Extract odds ratios for RASS AUCs for cleaner table
rass_est_death <- map_df(
  results_death,
  ~ filter(., str_detect(.$label, "^RASS"))
) %>%
  set_names(str_replace(names(.), "label", "exposure")) %>%
  mutate(
    outcome = "12m Death",
    est_nums = str_remove_all(est.ci, "\\(|\\)|,"),
    exposure = capitalize(str_remove(exposure, "^RASS AUC, "))
  ) %>%
  separate(
    est_nums,
    into = c("est", "lcl", "ucl"),
    sep = " "
  )

## Doesn't really make sense for Cox models  
# ## Data frames of predicted probabilities (P("higher ADL"))
# ## This loop pains me. I couldn't get map() to work on the deadline; it looked
# ##  like some weirdness due to multiple things being called .x? 🤷
# pred_adl <- vector("list", length = length(models_adl))
# for(i in 1:length(pred_adl)){
#   tmp <- eval(
#     parse(
#       text = sprintf(
#         "Predict(models_adl[[i]], %s = NA, fun = plogis)", expvars[i]
#       )
#     )
#   )
#   
#   pred_adl[[i]] <- as.data.frame(tmp) %>%
#     mutate(
#       outcome = "Katz ADL",
#       exposure = expvars[i],
#       timept = timepts[i],
#       xvar = .[[expvars[i]]]
#     )
# }
# 
# ## Combine into a single dataset for plotting
# pred_df_adl <- bind_rows(pred_adl) %>%
#   mutate(
#     timept = factor(paste0(timept, "M"), levels = c("3M", "12M")),
#     exposure = factor(
#       ifelse(exposure == "rass_auc_sed", 1, 0),
#       levels = 0:1, labels = c("All RASSes", "RASSes on Sedating Medications")
#     )
#   )

```

```{r results_death}
kable(
  rass_est_death %>%
    arrange(exposure) %>%
    dplyr::select(est.ci, pval),
  format = "html",
  caption = "Level of Consciousness vs 12M Mortality",
  col.names = c("Hazard Ratio (95% CI), 75th vs 25th %ile", "P"),
  align = c("r", "r")
) %>%
  group_rows(index = c("All RASSes" = 1, "RASSes while on sedation" = 1))

```

<details><summary>Full Model Results</summary>

### AUC, All RASSes vs Death, 12m

```{r death_total_12m}
kable(
  results_death[[1]],
  format = "html",
  col.names = c("Covariate", "Ref.", "Comp.", "HR (95% CI)", "X^2^", "df", "P"),
  align = c("l", rep("r", ncol(results_adl[[1]]) - 1))
)

```

### AUC, RASSes on Sedating Medications vs Death, 12m

```{r death_sed_12m}
kable(
  results_death[[2]],
  format = "html",
  col.names = c("Covariate", "Ref.", "Comp.", "HR (95% CI)", "X2", "df", "P"),
  align = c("l", rep("r", ncol(results_adl[[1]]) - 1))
)

```

</details>

# Session Info/Reproducibility

Analyses above are conducted using `r R.version$version.string`, including the following add-on packages.

<details><summary>Individual R Packages</summary>

```{r devtools}
## Uncomment this later; it just takes up so much screen real estate in the
##  console!
devtools::session_info()$packages

```

</details>
