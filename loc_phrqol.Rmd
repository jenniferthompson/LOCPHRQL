---
title: "Level of Consciousness vs Physical HRQOL"
author: "Jennifer Thompson, MPH<br>Supervisor: Rameela Chandrasekhar, PhD"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output:
  tufte::tufte_html:
    toc: TRUE
    toc_depth: 1
---

<style>
.plotlymargin { margin-right: 0; }
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

library(knitr)
library(tufte)
library(tidyverse)
library(stringr)
library(glue)
library(kableExtra)
library(tableone)
library(rms)
library(naniar)
library(plotly)
library(MESS)

load("data/brainmind_deid.Rdata")

## Source helper functions
source("R/helpers.R")
sum_na <- partial(sum, na.rm = TRUE)

## How many imputations for multiple imputation?
n_imp <- 15

## -- Remove variable labels (don't play nicely with pipes) --------------------
brainmind.oneobs <- clear.labels(brainmind.oneobs)
brainmind.daily <- clear.labels(brainmind.daily)
brainmind.fu <- clear.labels(brainmind.fu)
brainmind.exc <- clear.labels(brainmind.exc)

```

```{r consort_df}
## -- Determine status at each follow-up point ---------------------------------
fu_wide <- brainmind.fu %>%
  dplyr::select(id, fu.period, status) %>%
  filter(fu.period %in% paste(c(3, 12), "Month")) %>%
  mutate(
    ## Make ID character for compatibility with exclusion log
    id = as.character(id),
    fu.period = str_remove(fu.period, " Month"),
    status = forcats::fct_collapse(
      status,
      "Alive and in study" = c(
        "Living", "Living-Active in the study",
        "Lost to Follow-Up - Case Closed", "Visit Not Completed",
        "Still Trying to Contact"
      ),
      "Died before follow-up" = "Deceased",
      "Withdrew before follow-up" = "Living-Withdrew from the study"
    ),
    status = as.character(status)
  ) %>%
  spread(key = fu.period, value = status, sep = ".") %>%
  set_names(gsub("^fu\\.period", "status", names(.)))

screened_df <- bind_rows(
  brainmind.exc %>%
    mutate(
      id = paste(site, ex.id, sep = "-"),
      exc_status = case_when(
        stringr::str_sub(exc.rsn, 1, 2) == "9." ~ "Refused consent",
        TRUE                                    ~ "Excluded"
      )
    ) %>%
    dplyr::select(id, exc_status),
  brainmind.oneobs %>%
    dplyr::select(id, studywd.amt, died.inhosp) %>%
    mutate(
      id = as.character(id),
      exc_status = "Enrolled",
      wd_data = studywd.amt %in% c(
        "2. W/D from Participation and All Data Collected",
        "4. N/A Study Staff Withdrew Patient"
      ) | id == 14015 ## withdrew data, but staff did not record appropriately
    )
) %>%
  mutate(
    dc_status = factor(
      case_when(
        !is.na(died.inhosp) & died.inhosp == "Died in hospital" ~ 1,
        !is.na(studywd.amt)                                     ~ 2,
        !(exc_status == "Enrolled")                             ~ as.numeric(NA),
        TRUE                                                    ~ 3
      ),
      levels = 1:3,
      labels = c(
        "Died during hospitalization",
        "Withdrew during hospitalization",
        "ICU survivor"
      )
    )
  ) %>%
  left_join(fu_wide, by = "id") %>%
  ## Fill in missing statuses
  mutate(
    ## Assume missing at 3m indicates no follow-up but patient still alive and
    ##  in study (no death or withdrawal recorded)
    status.3 = case_when(
      !is.na(status.3) ~ status.3,
      exc_status != "Enrolled" |
        dc_status != "ICU survivor" ~
        as.character(NA),
      TRUE ~ "Alive and in study"
    ),
    ## 12m status is NA if patient died or withdrew before 3m; otherwise, if
    ##  missing, assume patient was alive and in study (no death/withdrawal rec.)
    status.12 = case_when(
      exc_status != "Enrolled" |
        dc_status != "ICU survivor" |
        status.3 %in% paste(c("Died", "Withdrew"), "before follow-up") ~
          as.character(NA),
      !is.na(status.12) ~ status.12,
      TRUE ~ "Alive and in study"
    )
  )

## -- IDs of patients in discharge, 3m, 12m cohorts ----------------------------
ids_discharge <- screened_df %>% filter(dc_status == "ICU survivor") %>% pull(id)
ids_3m <- screened_df %>% filter(status.3 == "Alive and in study") %>% pull(id)
ids_12m <- screened_df %>% filter(status.12 == "Alive and in study") %>% pull(id)

## -- Combine info for CONSORT table -------------------------------------------
consort_screen <- tribble(
  ~ current, ~ npts, ~ denom,
  "Screened", nrow(screened_df), NA,
  "Excluded", sum_na(screened_df$exc_status == "Excluded"), nrow(screened_df),
  "Approached", sum_na(screened_df$exc_status %in% c("Enrolled", "Refused consent")), nrow(screened_df),
  "Refused consent", sum_na(screened_df$exc_status == "Refused consent"),
    sum_na(screened_df$exc_status %in% c("Enrolled", "Refused consent")),
  "Enrolled", sum_na(screened_df$exc_status == "Enrolled"),
    sum_na(screened_df$exc_status %in% c("Enrolled", "Refused consent")),
  "Withdrew all data", sum_na(screened_df$wd_data),
    sum_na(screened_df$exc_status == "Enrolled"),
  "Eligible for in-hospital assessments", sum_na(!screened_df$wd_data),
    sum_na(screened_df$exc_status == "Enrolled")
)

n_elig_hosp <- sum_na(!screened_df$wd_data)

consort_inhosp <- tribble(
  ~ current, ~ npts,
  "Died in hospital",
    sum_na(screened_df$dc_status == "Died during hospitalization"),
  "Withdrew in hospital",
    sum_na(screened_df$dc_status == "Withdrew during hospitalization"),
  "Discharged, remained in study",
    sum_na(screened_df$dc_status == "ICU survivor")
) %>%
  mutate(denom = n_elig_hosp)

n_elig_dc <- sum_na(screened_df$dc_status == "ICU survivor")

## -- 3m followup section ------------------------------------------------------
consort_3m <- tribble(
  ~ current,                            ~ npts,
  "Alive and in study at discharge",
    sum_na(screened_df$dc_status == "ICU survivor"),
  "Died before 3m follow-up",
    sum_na(screened_df$status.3 == "Died before follow-up"),
  "Withdrew before 3m follow-up",
    sum_na(screened_df$status.3 == "Withdrew before follow-up"),
  "Included in 3m follow-up cohort",
    sum_na(screened_df$status.3 == "Alive and in study")
) %>%
  mutate(denom = n_elig_dc)

n_elig_3m <- sum_na(screened_df$status.3 == "Alive and in study")

## -- 12m followup section -----------------------------------------------------
consort_12m <- tribble(
  ~ current,                            ~ npts,
  "Alive and in study at 3m follow-up",
    sum_na(screened_df$status.3 == "Alive and in study"),
  "Died before 12m follow-up",
    sum_na(screened_df$status.12 == "Died before follow-up"),
  "Withdrew before 12m follow-up",
    sum_na(screened_df$status.12 == "Withdrew before follow-up"),
  "Included in 12m follow-up cohort",
    sum_na(screened_df$status.12 == "Alive and in study")
) %>%
  mutate(denom = n_elig_3m)

consort_info <- bind_rows(
  consort_screen, consort_inhosp, consort_3m, consort_12m
) %>%
  mutate(
    denom = ifelse(
      current %in%
        paste("Alive and in study at", c("discharge", "3m follow-up")),
      NA,
      denom
    ),
    prop = round(npts / denom, 2),
    npct = glue::glue("{npts} ({scales::percent(prop)})"),
    npct = stringr::str_remove(npct, " \\(NA\\%\\)")
)

```

```{r data_prep}
## -- Calculate AUC for lowest daily RASSes (exposure) -------------------------
## "AUC" = amount of "low LOC" each patient experienced in the hospital
## Very, very few research RASSes were >0; combine these with 0

## Find lowest research staff RASS on each study day
low_rasses_res <- brainmind.assess %>%
  filter(!is.na(rass.daily)) %>%
  group_by(id, study.day) %>%
  summarise(
    rass.low.res = min(rass.daily, na.rm = TRUE)
  ) %>%
  ungroup()

## Combine with lowest bedside RASSes
rass_for_auc <- brainmind.daily %>%
  left_join(low_rasses_res, by = c("id", "study.day")) %>%
  ## For each patient-day, find lowest RASS
  mutate(
    on_sedation = rcvd.benz | rcvd.op | rcvd.prop | rcvd.dex,
    lowest_rass = case_when(
      !is.na(rass.low.icu) & rass.low.icu < rass.low.res ~ rass.low.icu,
      TRUE                                               ~ rass.low.res
    ),
    ## Collapse all RASSes > 0 to 0
    ##  (very few; for our purposes they are equivalent)
    rass_distance = if_else(
      lowest_rass > 0, 0, lowest_rass * -1, missing = as.numeric(NA)
    )
  ) %>%
  ## Days without mental status available and without sedation info available
  ##  are generally days patient was discharged/died (last days of
  ##  hospitalization)
  filter(id %in% ids_discharge, !is.na(mental.stat.imp), !is.na(on_sedation)) %>%
  dplyr::select(id, study.day, on_sedation, lowest_rass, rass_distance)

# ## How many ICU survivors only have one RASS?
# rass_for_auc %>%
#   filter(!is.na(rass_distance)) %>%
#   group_by(id) %>%
#   count() %>%
#   filter(n == 1)

auc_ids <- rass_for_auc %>%
  filter(!is.na(rass_distance)) %>%
  group_by(id) %>% count() %>% filter(n > 1) %>% pull(id)

auc_values <- rass_for_auc %>%
  filter(id %in% auc_ids) %>%
  group_by(id) %>%
  summarise(
    rass_auc_total = auc(x = study.day, y = rass_distance, rule = 2)
  )

## -- Minor data management for baseline/hospital characteristics --------------
brainmind.oneobs <- brainmind.oneobs %>%
  mutate(
    frailty.e = as.numeric(stringr::str_sub(frailty, 1, 1)),
    hosp.type = factor(
      as.numeric(id >= 14000), levels = 0:1, labels = c("Civilian", "Veteran")
    ),
    dc.facility = factor(
      as.numeric(!hospdis.loc == "Home"),
      levels = 0:1, labels = c("Home", "Facility")
    ),
    ## For covariates, patients who were never on MV need 0 imputed for vent LOS
    vent.los.all = ifelse(!is.na(vent.los.tot), vent.los.tot, 0)
  ) %>%
  ## Add on RASS AUC
  left_join(auc_values, by = "id")

oneobs_covars <- c(
  "age.enroll", "sex.pp", "race.wb", "bmi", "edu", "charlson.score",
  "frailty.e", "faq.e", "hosp.type", "mean.modsofa.icu", "icudays.sevseptic.s",
  "vent.los.all", "hosp.los"
)

exposure_vars <- c("rass_auc_total")

outcome_vars <- c(
  "dc.facility",
  paste(c("adl", "faq", "sf36.pcs"), c(rep(3, 3), rep(12, 3)), sep = ".")
)

## -- Add outcome scores at each time point ------------------------------------
fu_subset <- brainmind.fu %>%
  filter(fu.period %in% paste(c(3, 12), "Month")) %>%
  dplyr::select(id, fu.period, adl.totscore, faq.totscore, sf36.pcs) %>%
  gather(key = test_name, value = test_score, -c(id, fu.period)) %>%
  mutate(
    fu.period = str_remove(fu.period, " Month"),
    test_name = str_remove(test_name, "\\.totscore")
  ) %>%
  unite(test_name, c(test_name, fu.period), sep = ".") %>%
  spread(key = test_name, value = test_score)

## -- Create datasets for patients, variables needed at each time point --------
df_full <- brainmind.oneobs %>% left_join(fu_subset, by = "id")

df_discharge <- df_full %>%
  filter(id %in% ids_discharge) %>%
  dplyr::select(id, one_of(oneobs_covars), dc.facility, one_of(exposure_vars))

df_3m <- df_full %>%
  filter(id %in% ids_3m) %>%
  dplyr::select(
    id,
    one_of(oneobs_covars),
    one_of(str_subset(names(fu_subset), "\\.3")),
    one_of(exposure_vars)
  )

df_12m <- df_full %>%
  filter(id %in% ids_12m) %>%
  dplyr::select(
    id,
    one_of(oneobs_covars),
    one_of(str_subset(names(fu_subset), "\\.12")),
    one_of(exposure_vars)
  )

```

The following analyses use data from the BRAIN-ICU and MIND-ICU cohorts to
examine the association between several measures of level of consciousness (LOC)
during critical illness and long-term disability, physical health-related
quality of life (pHRQOL), and mortality at 3 and 12 months following hospital discharge.

Throughout the analysis, level of consciousness (LOC) is measured using the Richmond Agitation-Sedation Scale (RASS). The RASS was performed by research
staff twice daily in the ICU and once daily outside the ICU during the
hospitalizations recorded in the parent studies. There are four exposures of
interest, each related to lowest daily RASS on days patients met specific
criteria.

# Study Aims

For all exposures, AUC is calculated using linear interpolation, with missing
values interpolated with the closest non-missing data point.

```{marginfigure, echo = TRUE}
**Exposure defintion, Aim 1:**

Area under the curve (AUC) of all lowest daily RASS's distance from 0 during hospitalization.

```

## Aim 1

We hypothesize that lower overall LOC during critical illness is associated with
greater disability and worsened physical health-related quality of life at 3 and
12 months after hospital discharge, after adjusting for other baseline and
hospitalization characteristics.

```{marginfigure, echo = TRUE}
**Exposure definition, Aim 2:**

Area under the curve (AUC) of all lowest daily RASS's distance from 0 on days
when patient received at least one of the following medications:
benzodiazepines; opioids; propofol; dexmedetomidine; haloperidol.

```

## Aim 2

We hypothesize that lower LOC **while patient is on sedating medications**
during critical illness is associated with greater disability and worsened
physical health-related quality of life at 3 and 12 months after hospital
discharge, after adjusting for other baseline and hospitalization characteristics.

```{marginfigure, echo = TRUE}
**Exposure definition, Aim 3:**

Area under the curve (AUC) of all lowest daily RASS's distance from 0 on days
when patient received benzodiazepines.

```

## Aim 3

We hypothesize that lower LOC **on days patients received benzodiazepines**
during critical illness is associated with greater disability and worsened
physical health-related quality of life at 3 and 12 months after hospital
discharge, after adjusting for other baseline and hospitalization characteristics, *including* doses of opioids and propofol.

```{marginfigure, echo = TRUE}
**Exposure definition, Aim 4:**

Area under the curve (AUC) of all lowest daily RASS's distance from 0 on days
when patient received propofol.

```

## Aim 4

We hypothesize that lower LOC **on days patients received propofol**
during critical illness is associated with greater disability and worsened
physical health-related quality of life at 3 and 12 months after hospital
discharge, after adjusting for other baseline and hospitalization characteristics, *including* doses of opioids and benzodiazepines.

## Outcome Definitions

For both aims, outcomes include the following, measured at 3 and 12 months
following hospital discharge:

- **Disability**
    - Katz Activities of Daily Living (ADL)
    - Pfeffer Functional Activities Questionnaire (FAQ)
    - Discharge destination (home vs facility)
- **Physical HRQOL**: Short Form-36 Physical Component Score (PCS)
- **Mortality**: Time to death at 90 and 365 days after discharge *(THIS IS A BIG MAYBE; event rates are very low for including this # covariates)*

# Statistical Methods

At each time point (hospital discharge, 3-month follow-up, and 12-month
follow-up), all patients will be included in analysis who were alive and not
officially withdrawn from the study.

## Model Choice

We will use the following types of multivariable regression to assess the
relationship between measures of LOC during hospitalization and each outcome
variable:

- Discharge location (home vs facility): logistic regression
- Katz ADL, Pfeffer FAQ: proportional odds logistic regression
- SF36 Physical Component Score: ordinary least squares (linear) regression
- Mortality at 90 and 365 days after enrollment: Cox proportional hazards regression

Model assumptions for each outcome and time point will be checked graphically.

## Model Covariates

All multivariable models will be adjusted for the following covariates:

- Baseline and ICU admission characteristics
    - Age
    - Sex
    - Race^[(white vs other race)]
    - BMI
    - Education
    - Charlson Comorbidity Index
    - CSHA Clinical Frailty Score at ICU admission
    - Pfeffer FAQ at ICU admission
    - Hospital type^[(civilian vs veteran)]
- Hospitalization characteristics
    - Mean daily SOFA score, modified^[*(GCS not included, as it is directly calculated from our primary exposure)*]
    - Duration of severe sepsis/septic shock
    - Duration of mechanical ventilation
    - Hospital length of stay

All continuous variables will be allowed to have a nonlinear relationship with
the outcome, using restricted cubic splines with three knots. This results in a
total of 22 degrees of freedom for covariates plus an additional 2df for
exposure variables (total of 25 in each model).

For aims 3 & 4 **only**, doses of opioids and propofol (Aim 3) or
benzodiazepines (Aim 4) will also be included as covariates, as these
medications may confound the association between benzodiazepine- or propofol-
related LOC, respectively, and outcomes.

<div class = 'marginnote plotlymargin'>
```{r miss_outcomes, fig.margin = TRUE, fig.cap = "% of Eligible Patients with Missing Outcomes", fig.width = 4, fig.height = 3}
missing_outcomes <- list(
  df_discharge %>% dplyr::select(dc.facility),
  df_3m %>% dplyr::select(one_of(outcome_vars)),
  df_12m %>% dplyr::select(one_of(outcome_vars))
) %>%
  map_df(miss_var_summary) %>%
  separate(variable, into = c("asmt", "timept"), sep = "\\.(?=\\d+$)") %>%
  mutate(
    asmt = case_when(
      asmt == "dc.facility" ~ "D/C Loc.",
      asmt == "sf36.pcs"    ~ "PCS",
      TRUE                  ~ toupper(asmt)
    ),
    asmt = fct_relevel(asmt, "D/C Loc.", after = 3L),
    timept = case_when(
      is.na(timept) ~ "D/C",
      TRUE ~ paste0(timept, "M")
    ),
    htext = glue("{n_miss} ({round(pct_miss)}%)")
  )

## Plotly won't stay in the margin?
plot_ly(
  missing_outcomes,
  x = ~ pct_miss,
  y = ~ asmt,
  text = ~ htext,
  color = ~ timept,
  type = "bar", orientation = "h", hoverinfo = "text",
  colors = c("#007471", "#003d74", "#000374")
) %>%
  layout(
    barmode = "dodge",
    xaxis = list(title = ""),
    yaxis = list(title = ""),
    legend = list(orientation = "h", traceorder = "reversed")
  )

```
</div>

## Missing Data

At each time point, all patients will be included in analysis who remained alive
and in the study. Missing data for covariates (quite minimal; detailed below)
and outcomes will be handled using multiple imputation using predictive mean
matching with `r n_imp` imputations, using R's `Hmisc::aregImpute()` and `rms::fit.mult.impute()` functions. Proportions of eligible patients with each
outcome data point available are shown to the right. The maximum amount missing
for any individual covariate at any time point is <2%. At hospital discharge, `r scales::percent(prop_miss_case(df_discharge))` of eligible patients are missing
outcome or covariate data; at 3-month follow-up,
`r scales::percent(prop_miss_case(df_3m))` patients; and at 12-month follow-up,
`r scales::percent(prop_miss_case(df_12m))`. Using multiple imputation is
particularly important for follow-up outcomes, where we suspect that the
patients who might have the worst outcomes are most prone to missingness.

```{r missing_data}
df_missing <- bind_rows(
  df_discharge %>% mutate(timept = "Hospital Discharge"),
  df_3m %>% mutate(timept = "3 Months"),
  df_12m %>% mutate(timept = "12 Months")
) %>%
  mutate(
    timept = forcats::fct_relevel(timept, "Hospital Discharge", "3 Months")
  ) %>%
  dplyr::select(timept, one_of(oneobs_covars)) ## one_of(exposure_vars)

```

<details><summary>Details of Missingness among Covariates</summary>
```{r plot_missing, fig.fullwidth = TRUE}
miss_plot <- naniar::gg_miss_var(df_missing, timept, show_pct = TRUE) +
  scale_y_continuous(name = "% Missing", limits = c(0, 5)) +
  geom_hline(yintercept = 5, colour = "gray50", linetype = "dotted") +
  theme(axis.title.y = element_blank())

ggplotly(miss_plot)

```

</details>

# Study Cohort

Analyses will include all ICU survivors who were alive and remained in the study
(ie, had not withdrawn) at the specified time point. Patients who died or
officially withdrew from the study prior to assessment are not included in analyses at that time point. Missing data for individual assessments will be
handled via multiple imputation.

```{r print_consort}
consort_info %>%
  dplyr::select(current, npct) %>%
  kable(
    format = "html", col.names = c("", "N (%)"), align = c("l", "r"),
    escape = FALSE
  ) %>%
  group_rows("Screening", 1, 7) %>%
  group_rows("In-Hospital", 8, 10) %>%
  group_rows("Three-Month Follow-Up", 11, 14) %>%
  group_rows("Twelve-Month Follow-Up", 15, 18) %>%
  row_spec(row = c(7, 10, 14, 18), bold = TRUE) %>%
  kable_styling(full_width = FALSE, position = "left")

```
